<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Address Book</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<div class="topnav">
    <a class="active" href="index.html">Add New Records</a>
    <a href="list.html">List of Records</a>
    <a href="search.html">Search Page</a>
</div>

    <div class="container" id="main_container">
        <h1>Please enter a name and a number for each record</h1>
        <form id="grids">
            <div class="grid-container">
                <span class="index">1. </span>
                <div class="input-container">
                    <input class="input" type="text" placeholder="Name" name="name" onchange="validate(this)">
                </div>
                <div class="input-container">
                    <input class="input" type="text" placeholder="Phone Number" name="phone" onchange="validate(this)">
                </div>
            </div>
        </form>
        <div id="sticky_button">
            <button class="button" onclick="processForm()">Sumbit records</button>
        </div>
    </div>

    <script>
        const NUMBEROFINPUTS = 50;

        const target = document.getElementById("grids");
        const node = document.getElementsByClassName("grid-container")[0];
        for (let x = 1; x < NUMBEROFINPUTS; x++){
            const newNode = node.cloneNode(true);
            newNode.getElementsByClassName("index")[0].textContent = `${(x+1)}. `;
            target.appendChild(newNode);
        }
        
        const validate = (input) => {
            if(input.name === "name"){
                const regName = /^[A-Za-z\s]*$/;
                if (!regName.test(input.value)){
                    errorValidation(input, "Only letters are allowed");
                }else{
                    const sibling = input.parentElement.nextElementSibling.children[0];
                    successValidation(input, sibling);
                }
            }else{
                const regPhone = /^(\+(?!01)|0)(?:[^()]*|[^()]*\([^()]*\)[^()]*)[0-9]{6,}$/;
                if (!regPhone.test(input.value)){
                    errorValidation(input, "Phone number should start with + OR 0, and contain at least 7 numbers");
                }else{
                    const sibling = input.parentElement.previousElementSibling.children[0];
                    successValidation(input, sibling);
                }
            }
        }

        const errorValidation = (input, message) => {
            input.classList.remove("success");
            input.classList.add("error");
            input.parentElement.setAttribute("data-tip", message);
        }

        const successValidation = (input, sibling) => {
            input.classList.remove("error");
            input.classList.add("success");
            input.parentElement.removeAttribute("data-tip");

            if(sibling.value === ""){
                sibling.classList.add("error");
                sibling.parentElement.setAttribute("data-tip", "You need to provide a name and a phone per each record");
            }
        }

        const processForm = () => {
            const records = document.getElementsByClassName("grid-container");
            let counter = 0;
            
            //Get current records
            let recordsList = [];
            if (localStorage.getItem("records")){
                recordsList = JSON.parse(localStorage.getItem("records"));
            }
            
            const submission = (ArrayOfInputs) => {
                for (let input of ArrayOfInputs) {
                    input.disabled = true;
                    input.classList.add("submitted");
                    input.classList.remove("success");
                    input.parentElement.setAttribute("data-tip", "Record Submitted!");
                }
            }
            
            for (let row of records) {
                //Look only for valid records
                let sucInputs = row.getElementsByClassName("success");
                
                if (sucInputs.length !== 2){
                    continue;
                }
                
                let nameInput = row.getElementsByClassName("input-container")[0].children[0];
                let phoneInput = row.getElementsByClassName("input-container")[1].children[0];

                //Check if the record is already added
                recordsList.map((item) => { 
                    if (item.name.toLowerCase() === nameInput.value.toLowerCase())
                        errorValidation(nameInput, "This Name is already registered");

                    if (item.phone === phoneInput.value)
                        errorValidation(phoneInput, "This Phone Number is already registered");
                });

                //if both records are new, add them
                if (sucInputs.length === 2){
                    counter++;
                    recordsList.push({
                        "name": nameInput.value,
                        "phone": phoneInput.value
                    })
                    submission([nameInput, phoneInput]);
                }
            }

            localStorage.setItem('records', JSON.stringify(recordsList));
            alert(`${(counter)} new records added!`);
        }
    </script>
</body>
</html>
